name: Build curl + NSS (Windows x64, native)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      CURL_VERSION: "8.17.0"
      NSPR_VERSION: "4.33"
      NSS_VERSION: "3.100"
      PREFIX: ${{ github.workspace }}/dist/windows

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # --------------------------
      # Install dependencies
      # --------------------------
      - name: Install dependencies
        run: |
          choco install -y git cmake ninja

      # --------------------------
      # Download NSPR
      # --------------------------
      - name: Download NSPR
        run: |
          Invoke-WebRequest -Uri "https://ftp.mozilla.org/pub/nspr/releases/v${env:NSPR_VERSION}/src/nspr-${env:NSPR_VERSION}.tar.gz" -OutFile "nspr-${env:NSPR_VERSION}.tar.gz"
          tar -xzf "nspr-${env:NSPR_VERSION}.tar.gz"
          # 两级目录处理
          Move-Item -Path "nspr-${env:NSPR_VERSION}\nspr" -Destination "nspr"
          Remove-Item -Recurse -Force "nspr-${env:NSPR_VERSION}"

      - name: Build NSPR
        shell: powershell
        run: |
          cd nspr
          nmake /f Makefile.nt TARGET=U /nologo
          mkdir -p $env:PREFIX/include/nspr
          Copy-Item -Recurse public/* $env:PREFIX/include/nspr
          mkdir -p $env:PREFIX/lib
          Copy-Item lib/*.lib $env:PREFIX/lib

      # --------------------------
      # Download NSS
      # --------------------------
      - name: Download NSS
        run: |
          Invoke-WebRequest -Uri "https://ftp.mozilla.org/pub/security/nss/releases/NSS_${env:NSS_VERSION}_RTM/src/nss-${env:NSS_VERSION}.tar.gz" -OutFile "nss-${env:NSS_VERSION}.tar.gz"
          tar -xzf "nss-${env:NSS_VERSION}.tar.gz"
          # 两级目录处理
          Move-Item -Path "nss-${env:NSS_VERSION}\nss" -Destination "nss"
          Remove-Item -Recurse -Force "nss-${env:NSS_VERSION}"

      - name: Build NSS
        shell: powershell
        run: |
          cd nss
          nmake /f Makefile.nt TARGET=U /nologo
          mkdir -p $env:PREFIX/include/nss
          Copy-Item -Recurse public/* $env:PREFIX/include/nss
          mkdir -p $env:PREFIX/lib
          Copy-Item lib/*.lib $env:PREFIX/lib

      # --------------------------
      # Clone curl
      # --------------------------
      - name: Clone curl
        run: git clone --branch curl-${{ env.CURL_VERSION }} https://github.com/curl/curl.git curl-src

      # --------------------------
      # Build curl with NSS
      # --------------------------
      - name: Build curl
        shell: powershell
        run: |
          mkdir curl-build
          cd curl-build
          cmake ..\curl-src `
            -G "NMake Makefiles" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCURL_USE_NSS=ON `
            -DNSS_ROOT=$env:PREFIX `
            -DBUILD_CURL_EXE=ON `
            -DBUILD_SHARED_LIBS=OFF
          nmake /nologo

      # --------------------------
      # Package output
      # --------------------------
      - name: Package curl
        shell: powershell
        run: |
          mkdir -p $env:PREFIX/bin
          Copy-Item curl-build/src/curl.exe $env:PREFIX/bin
          Copy-Item $env:PREFIX/lib/*.dll $env:PREFIX/bin -ErrorAction SilentlyContinue
          Compress-Archive -Path $env:PREFIX/bin/* -DestinationPath $env:PREFIX/curl-nss-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: curl-nss-windows
          path: ${{ env.PREFIX }}/curl-nss-windows.zip
