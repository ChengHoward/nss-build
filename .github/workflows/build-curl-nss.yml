name: Build curl + NSS (Windows x64 via vcpkg)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      CURL_VERSION: "8_17_0"
      PREFIX: ${{ github.workspace }}/dist/windows
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # --------------------------
      # Install vcpkg if not cached
      # --------------------------
      - name: Install vcpkg
        run: |
          if (-not (Test-Path $env:VCPKG_ROOT\vcpkg.exe)) {
            git clone https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT
            & "$env:VCPKG_ROOT/bootstrap-vcpkg.bat"
          }

      # --------------------------
      # Cache vcpkg installed libraries
      # --------------------------
      - name: Cache vcpkg
        uses: actions/cache@v3
        with:
          path: |
            ${{ github.workspace }}/vcpkg/installed
            ${{ github.workspace }}/vcpkg/downloads
          key: vcpkg-${{ runner.os }}-x64
          restore-keys: vcpkg-${{ runner.os }}-x64

      # --------------------------
      # Install curl[nss] port via vcpkg
      # --------------------------
      - name: Install curl[nss]
        run: |
          $installed = & "$env:VCPKG_ROOT\vcpkg.exe" list
          if ($installed -notmatch "curl:x64-windows") {
            & "$env:VCPKG_ROOT\vcpkg.exe" install curl[nss]:x64-windows --recurse
          }

      # --------------------------
      # Cache curl source
      # --------------------------
      - name: Cache curl source
        uses: actions/cache@v3
        with:
          path: curl-src
          key: curl-src-${{ runner.os }}-${{ env.CURL_VERSION }}

      # --------------------------
      # Clone curl if not cached
      # --------------------------
      - name: Clone curl
        run: |
          if (-not (Test-Path curl-src)) {
            git clone https://github.com/curl/curl.git curl-src
            cd curl-src
            git checkout tags/curl-${{ env.CURL_VERSION }} -b build-${{ env.CURL_VERSION }}
          }

      # --------------------------
      # Build curl with vcpkg toolchain
      # --------------------------
      - name: Build curl
        shell: pwsh
        run: |
          if (-not (Test-Path curl-build)) { mkdir curl-build }
          cd curl-build

          $VCPKG_TOOLCHAIN = "${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake"

          cmake ..\curl-src `
            -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_TOOLCHAIN" `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_CURL_EXE=ON `
            -DBUILD_SHARED_LIBS=OFF `
            -DCURL_USE_LIBPSL=OFF

          cmake --build . --config Release

      # --------------------------
      # Package output
      # --------------------------
      - name: Package curl
        shell: pwsh
        run: |
          if (Test-Path $env:PREFIX/bin) { Remove-Item $env:PREFIX/bin -Recurse -Force }
          mkdir $env:PREFIX/bin

          # 拷贝 curl.exe
          Copy-Item curl-build/src/Release/curl.exe $env:PREFIX/bin

          # 拷贝 NSS DLL
          Copy-Item "$env:VCPKG_ROOT/installed/x64-windows/bin/nss*.dll" $env:PREFIX/bin -ErrorAction SilentlyContinue

          Compress-Archive -Path "$env:PREFIX/bin/*" -DestinationPath "$env:PREFIX/curl-nss-windows.zip"

      # --------------------------
      # Upload artifact
      # --------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: curl-nss-windows
          path: ${{ env.PREFIX }}/curl-nss-windows.zip
