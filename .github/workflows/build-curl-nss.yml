name: Build curl + NSS (Windows x64)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      PREFIX: ${{ github.workspace }}/dist/windows
      CURL_VERSION: "8.17.0"
      NSPR_VERSION: "4.33"
      NSS_VERSION: "3.100"
      DEBIAN_FRONTEND: noninteractive
      TZ: Etc/UTC

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential mingw-w64 git cmake zip wget unzip autoconf libtool pkg-config

      # --------------------------
      # NSPR
      # --------------------------
      - name: Download NSPR
        run: |
          wget https://ftp.mozilla.org/pub/nspr/releases/v${NSPR_VERSION}/src/nspr-${NSPR_VERSION}.tar.gz
          tar xf nspr-${NSPR_VERSION}.tar.gz
          # 两级目录处理：内层是 nspr
          mv nspr-${NSPR_VERSION}/nspr nspr
          rm -rf nspr-${NSPR_VERSION}

      - name: Build NSPR (cross-compile Windows x64)
        run: |
          cd nspr
          ./configure --host=x86_64-w64-mingw32 --prefix=$PREFIX
          make -j$(nproc)
          # 手动拷贝头文件和库
          mkdir -p $PREFIX/include/nspr
          cp -r public/* $PREFIX/include/nspr/
          mkdir -p $PREFIX/lib
          cp lib/*.a $PREFIX/lib/

      # --------------------------
      # NSS
      # --------------------------
      - name: Download NSS
        run: |
          wget https://ftp.mozilla.org/pub/security/nss/releases/NSS_${NSS_VERSION}_RTM/src/nss-${NSS_VERSION}.tar.gz
          tar xf nss-${NSS_VERSION}.tar.gz
          # 两级目录处理：内层是 nss
          mv nss-${NSS_VERSION}/nss nss
          rm -rf nss-${NSS_VERSION}

      - name: Build NSS (cross-compile Windows x64)
        run: |
          cd nss
          make BUILD_OPT=1 TARGET=Win32 CROSS_COMPILE=x86_64-w64-mingw32
          mkdir -p $PREFIX/include/nss
          cp -r public/* $PREFIX/include/nss/
          mkdir -p $PREFIX/lib
          cp lib/*.a $PREFIX/lib/

      # --------------------------
      # curl
      # --------------------------
      - name: Clone curl
        run: |
          git clone --branch curl-${CURL_VERSION} https://github.com/curl/curl.git curl-src

      - name: Build curl (cross-compile Windows x64)
        run: |
          mkdir curl-build && cd curl-build
          cmake ../curl-src \
            -DCMAKE_BUILD_TYPE=Release \
            -DCURL_USE_NSS=ON \
            -DNSS_ROOT=$PREFIX \
            -DBUILD_CURL_EXE=ON \
            -DBUILD_SHARED_LIBS=OFF
          make -j$(nproc)

      # --------------------------
      # Package output
      # --------------------------
      - name: Package Windows curl
        run: |
          mkdir -p $PREFIX/bin
          cp curl-build/src/curl.exe $PREFIX/bin/
          # 如果有 dll，可以一起打包
          cp $PREFIX/lib/*.dll $PREFIX/bin/ || true
          cd $PREFIX
          zip -r curl-nss-windows.zip bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: curl-nss-windows
          path: $PREFIX/curl-nss-windows.zip
