name: Build curl + NSS (Windows x64 via vcpkg)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      CURL_VERSION: "8.17.0"
      NSPR_VERSION: "4.33"
      NSS_VERSION: "3.100"
      PREFIX: ${{ github.workspace }}/dist/windows
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # --------------------------
      # Install vcpkg
      # --------------------------
      - name: Install vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT
          & "$env:VCPKG_ROOT/bootstrap-vcpkg.bat"

      # --------------------------
      # Install dependencies via vcpkg
      # --------------------------
      - name: Install curl dependencies
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" install zlib:x64-windows brotli:x64-windows zstd:x64-windows nghttp2:x64-windows nss:x64-windows

      # --------------------------
      # Clone curl
      # --------------------------
      - name: Clone curl
        run: git clone --branch curl-${{ env.CURL_VERSION }} https://github.com/curl/curl.git curl-src

      # --------------------------
      # Build curl with NSS via vcpkg
      # --------------------------
      - name: Build curl
        run: |
          mkdir curl-build
          cd curl-build
          cmake ..\curl-src `
            -A x64 `
            -DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake `
            -DCMAKE_BUILD_TYPE=Release `
            -DCURL_USE_NSS=ON `
            -DBUILD_CURL_EXE=ON `
            -DBUILD_SHARED_LIBS=OFF
          cmake --build . --config Release

      # --------------------------
      # Package output
      # --------------------------
      - name: Package curl
        run: |
          mkdir -p $env:PREFIX/bin
          Copy-Item curl-build/src/Release/curl.exe $env:PREFIX/bin
          # 拷贝可能的 NSS dll
          Copy-Item $env:VCPKG_ROOT\installed\x64-windows\bin\*.dll $env:PREFIX/bin -ErrorAction SilentlyContinue
          Compress-Archive -Path $env:PREFIX/bin/* -DestinationPath $env:PREFIX/curl-nss-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: curl-nss-windows
          path: ${{ env.PREFIX }}/curl-nss-windows.zip
